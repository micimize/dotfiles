# btrbk configuration for backing up /home/mjr to AWS
#
# Usage:
#   btrbk -c /path/to/this/file -v -n run  # dry-run
#   btrbk -c /path/to/this/file -v run      # actual backup
#
# Before using:
#   1. Convert directories to subvolumes: sudo ./btrfs/local/convert-to-subvolumes.sh --dry-run
#   2. Update SSH_AUTH_SOCK if needed (for 1Password)
#   3. Test SSH: ssh ubuntu@54.177.219.117

# --- Global Settings ---

# Timestamp format for snapshot names
timestamp_format        long

# SSH identity: Use 1Password SSH agent
# This requires SSH_AUTH_SOCK to be set (usually: ~/.1password/agent.sock)
# btrbk will use the SSH agent automatically, no ssh_identity needed

# Snapshot retention policy
# Format: <hourly> <daily> <weekly> <monthly> <yearly>
# Examples:
#   "24h 7d 4w 6m" = keep 24 hourly, 7 daily, 4 weekly, 6 monthly snapshots
#   "no no 4w 12m" = keep only weekly and monthly
snapshot_preserve_min   latest

# Local snapshot retention
snapshot_preserve       14d 8w 12m

# Remote (AWS) snapshot retention
# More aggressive to save on EBS costs
target_preserve_min     latest
target_preserve         7d 4w 6m

# Snapshot directory (relative to subvolume)
# Snapshots will be stored in <subvolume>/.snapshots/
snapshot_dir            .snapshots

# Create snapshot directory if it doesn't exist
snapshot_create_always  yes

# --- Hooks ---

# Snapshot cleanup hook: Removes sensitive files BEFORE snapshot is made read-only
# This runs after snapshot creation but before it's finalized
snapshot_create_exec /home/mjr/code/personal/dotfiles/btrfs/local/snapshot-cleanup-hook.sh

# --- SSH Configuration ---

# Backend for btrfs send/receive
# Use 'btrfs-progs-sudo' if you need sudo on the remote side
# Use 'btrfs-progs-btrbk' if btrbk-ssh wrapper is configured
backend btrfs-progs-sudo

# SSH options
# -o StrictHostKeyChecking=no: Don't prompt for host key verification
# -o UserKnownHostsFile=/dev/null: Don't save host keys
ssh_identity            /dev/null  # Placeholder, we use SSH agent
ssh_user                ubuntu
ssh_compression         yes
stream_compress         xz

# --- Backup Targets ---

# Each subvolume under /home/mjr will be backed up independently
# Remote path preserves structure: /backup_volume/backups/home/mjr/<subvolume>/

volume /home/mjr
  # Snapshots are stored locally in each subvolume's .snapshots/ directory
  snapshot_dir            .snapshots

  # Remote backup target
  target ssh://ubuntu@54.177.219.117/backup_volume/backups/home/mjr/

  # Preserve directory structure on remote
  # This creates /backup_volume/backups/home/mjr/code, /home/mjr/Documents, etc.

  # Backup each subvolume
  subvolume code
  subvolume Dygma
  subvolume Documents
  subvolume Desktop
  subvolume Templates
  subvolume Pictures
  subvolume Public
  subvolume Videos
  subvolume Music
  subvolume .config
  subvolume .dev_sculptor
  subvolume .sculptor
  subvolume .mozilla

# --- Notes ---
#
# Subvolume Requirements:
#   All directories listed above MUST be btrfs subvolumes.
#   Use convert-to-subvolumes.sh to convert existing directories.
#
# Testing:
#   # Dry run (see what would happen):
#   btrbk -c btrfs/local/btrbk.conf -v -n run
#
#   # Run backup for one subvolume only:
#   btrbk -c btrfs/local/btrbk.conf run /home/mjr/code
#
#   # Full backup:
#   btrbk -c btrfs/local/btrbk.conf -v run
#
# Listing snapshots:
#   btrbk -c btrfs/local/btrbk.conf list snapshots
#   btrbk -c btrfs/local/btrbk.conf list backups
#
# Restoring:
#   # List available backups:
#   ssh ubuntu@54.177.219.117 "sudo btrfs subvolume list /backup_volume/backups"
#
#   # Restore a specific snapshot (manual process):
#   # 1. Receive the snapshot from remote:
#   ssh ubuntu@54.177.219.117 "sudo btrfs send /backup_volume/backups/home/mjr/code/code.20250101-1200" | \
#     sudo btrfs receive /home/mjr/.restore/
#
#   # 2. Copy files from snapshot to destination:
#   sudo rsync -av /home/mjr/.restore/code.20250101-1200/ /home/mjr/code-restored/
