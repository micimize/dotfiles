# btrbk configuration for backing up /home/mjr to AWS
#
# This configuration manages multi-subvolume backups using btrbk.
# Each directory under /home/mjr is a separate btrfs subvolume with independent
# snapshot and retention policies.
#
# Usage:
#   # With cleanup (recommended - removes git-ignored files from snapshots):
#   ./btrbk-with-cleanup.sh -v -n run  # dry-run (recommended first!)
#   ./btrbk-with-cleanup.sh -v run      # actual backup with cleanup
#
#   # Without cleanup (faster, but includes git artifacts in snapshots):
#   btrbk -c /path/to/this/file -v -n run  # dry-run
#   btrbk -c /path/to/this/file -v run      # actual backup
#   btrbk -c /path/to/this/file snapshot    # create local snapshots only
#
# Before using:
#   1. Convert directories to subvolumes: sudo ./create-subvolumes.py --dry-run
#   2. Ensure SSH access works: ssh ubuntu@54.177.219.117
#   3. Set SSH_AUTH_SOCK if using 1Password SSH agent
#   4. Verify btrfs tools are installed: btrbk --version

# --- Global Settings ---

# Timestamp format for snapshot names
# Options: long (default), short, long-iso, short-iso
# long format: YYYYMMDD-HHMM (e.g., 20250103-1430)
timestamp_format        long

# Snapshot retention policy
# Format: <hourly> <daily> <weekly> <monthly> <yearly>
# Examples:
#   "24h 7d 4w 6m" = keep 24 hourly, 7 daily, 4 weekly, 6 monthly snapshots
#   "no no 4w 12m" = keep only weekly and monthly
#   "14d" = keep 14 daily snapshots (no hourly, weekly, monthly, yearly)
#
# snapshot_preserve_min: Minimum snapshots to keep (regardless of age)
# snapshot_preserve: Retention policy for local snapshots
snapshot_preserve_min   latest
snapshot_preserve       14d 8w 12m

# Remote (AWS) backup retention
# More aggressive retention to save on EBS costs
# target_preserve_min: Minimum backups to keep on remote
# target_preserve: Retention policy for remote backups
target_preserve_min     latest
target_preserve         90d 52w 120m

# Snapshot directory (relative to subvolume)
# Snapshots will be stored in <subvolume>/.snapshots/
# This directory will be created automatically if it doesn't exist
snapshot_dir            .snapshots

# When to create snapshots
# Options: always, onchange, ondemand, no
#   always = always create snapshot (recommended for regular backups)
#   onchange = only create if source has changed since last snapshot
#   ondemand = only create when explicitly requested
snapshot_create         always

# Use incremental send/receive when possible
# This significantly reduces bandwidth and storage for backups
# Requires a common snapshot between source and target
incremental             yes


# --- Hooks ---
#
# NOTE: btrbk does NOT support exec hooks like snapshot_create_exec.
# The btrbk maintainer has explicitly rejected this feature due to security concerns.
# See: https://github.com/digint/btrbk/issues/58
#
# Snapshot cleanup solution:
#   Use btrbk-with-cleanup.sh wrapper script instead of running btrbk directly.
#   This script creates snapshots, runs snapshot-cleanup-hook.py on each one
#   (removing git-ignored files), then continues with the backup.
#
#   Usage:
#     ./btrbk-with-cleanup.sh -v -n run  # dry-run
#     ./btrbk-with-cleanup.sh -v run     # full backup with cleanup
#
# Alternative approaches (if not using the wrapper):
#   1. Run 'btrbk snapshot', manually clean snapshots, then 'btrbk run'
#   2. Use system-level hooks (e.g., systemd service hooks)
#   3. Use btrbk without cleanup (simplest, but snapshots will include git artifacts)

# --- SSH Configuration ---

# Backend for btrfs send/receive
# Options:
#   btrfs-progs-sudo: Run btrfs commands with sudo on remote (recommended for most setups)
#   btrfs-progs-btrbk: Use btrbk-ssh wrapper script (requires setup)
#   btrfs-progs-local: Local only, no SSH
backend                 btrfs-progs-sudo

# SSH user for remote connection
# The user must have sudo privileges for btrfs commands on the remote system
ssh_user                ubuntu

# SSH identity file
# Set to /dev/null when using SSH agent (e.g., 1Password SSH agent)
# Otherwise, specify path to private key (e.g., ~/.ssh/id_rsa)
# This requires SSH_AUTH_SOCK environment variable to be set
ssh_identity            /dev/null

# Enable SSH compression (reduces bandwidth usage)
ssh_compression         yes

# Stream compression for btrfs send/receive
# Options: gzip, pigz, bzip2, bzip3, xz, lz4, zstd, no
# xz provides good compression but is CPU-intensive
# lz4 is faster but less compression
stream_compress         xz

# --- Backup Targets ---

# Volume configuration for /home/mjr
# Each subvolume under /home/mjr will be backed up independently with its own
# snapshot history. This allows granular restores and independent retention policies.
#
# The multi-subvolume approach provides:
#   - Independent backup/restore for each directory
#   - Efficient incremental backups
#   - Per-subvolume snapshot retention
#
volume /home/mjr
  # Snapshots are stored locally in each subvolume's .snapshots/ directory
  # This inherits from the global snapshot_dir setting above
  snapshot_dir            .snapshots

  # Remote backup target on AWS EC2 instance
  # Format: ssh://user@host/path
  # Remote path structure: /backup_volume/backups/home/mjr/<subvolume>/
  # Each subvolume gets its own directory on the remote system
  target ssh://ubuntu@54.177.219.117/backup_volume/backups/home/mjr/

  # Subvolumes to backup
  # IMPORTANT: Each directory listed here MUST be a btrfs subvolume
  # Use create-subvolumes.py to convert regular directories to subvolumes
  #
  # To verify subvolumes: sudo btrfs subvolume list /home
  # To check specific dir: sudo btrfs subvolume show /home/mjr/<subvolume>

  subvolume code          # Source code repositories
  subvolume Dygma         # Keyboard configuration
  subvolume Documents     # Personal documents
  subvolume Desktop       # Desktop files
  subvolume Templates     # Document templates
  subvolume Pictures      # Photo library
  subvolume Public        # Public shared files
  subvolume Videos        # Video files
  subvolume Music         # Music library
  subvolume .config       # Application configurations
  subvolume .dev_sculptor # Development tools
  subvolume .sculptor     # Sculptor AI data
  subvolume .mozilla      # Firefox profiles

# --- Common Operations ---
#
# Testing (always run dry-run first!):
#   btrbk -c btrfs/local/btrbk.conf -v -n run
#
# Create snapshots only (no remote backup):
#   btrbk -c btrfs/local/btrbk.conf -v snapshot
#
# Full backup (snapshot + send to remote):
#   btrbk -c btrfs/local/btrbk.conf -v run
#
# Backup specific subvolume only:
#   btrbk -c btrfs/local/btrbk.conf run /home/mjr/code
#
# List snapshots and backups:
#   btrbk -c btrfs/local/btrbk.conf list snapshots
#   btrbk -c btrfs/local/btrbk.conf list backups
#   btrbk -c btrfs/local/btrbk.conf list latest
#
# Show stats:
#   btrbk -c btrfs/local/btrbk.conf stats
#
# Clean up old snapshots (respecting retention policy):
#   btrbk -c btrfs/local/btrbk.conf clean
#
# --- Restoring from Backup ---
#
# 1. List available backups on remote:
#    ssh ubuntu@54.177.219.117 "sudo btrfs subvolume list /backup_volume/backups"
#
# 2. Receive a specific snapshot from remote:
#    ssh ubuntu@54.177.219.117 "sudo btrfs send /backup_volume/backups/home/mjr/code/code.20250101-1430" | \
#      sudo btrfs receive /tmp/restore/
#
# 3. Make the received snapshot writable (it's read-only by default):
#    sudo btrfs property set -ts /tmp/restore/code.20250101-1430 ro false
#
# 4. Copy or move files to final destination:
#    sudo rsync -av /tmp/restore/code.20250101-1430/ /home/mjr/code-restored/
#    # Or: sudo mv /tmp/restore/code.20250101-1430 /home/mjr/code-restored
#
# 5. Clean up:
#    sudo btrfs subvolume delete /tmp/restore/code.20250101-1430
#
# --- Troubleshooting ---
#
# Check if directories are subvolumes:
#   sudo btrfs subvolume show /home/mjr/code
#
# List all subvolumes:
#   sudo btrfs subvolume list /home
#
# Verify SSH access to remote:
#   ssh ubuntu@54.177.219.117 "sudo btrfs subvolume list /backup_volume"
#
# Test btrfs send/receive locally:
#   sudo btrfs subvolume snapshot -r /home/mjr/code /tmp/test-snapshot
#   sudo btrfs send /tmp/test-snapshot | sudo btrfs receive /tmp/test-receive/
#
# Debug btrbk with verbose output:
#   btrbk -c btrfs/local/btrbk.conf -v -l debug run
